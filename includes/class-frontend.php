<?php
namespace ArmoMakeup;

class Frontend {
    public function init() {
        add_action('wp_enqueue_scripts', array($this, 'enqueue_scripts'));
        add_action('woocommerce_after_single_product_summary', array($this, 'add_virtual_makeup_button_float'), 5);
        add_action('woocommerce_single_product_summary', array($this, 'add_virtual_makeup_button_fixed'), 20);
        add_action('wp_footer', array($this, 'add_modal_markup'));

        // Add AJAX handler
        add_action('wp_ajax_load_makeup_iframe', array($this, 'load_makeup_iframe'));
        add_action('wp_ajax_nopriv_load_makeup_iframe', array($this, 'load_makeup_iframe'));
    }

    public function enqueue_scripts() {
        if (!is_product()) {
            return;
        }

        $product_id = get_the_ID();
        $is_enabled = get_post_meta($product_id, 'is_enable_virtual_makeup', true);

        if ($is_enabled != 'yes') {
            return;
        }
    
        // Enqueue MicroModal.js
        wp_enqueue_script('micromodal', 'https://unpkg.com/micromodal/dist/micromodal.min.js', array(), '0.4.10', true);
    
        // Enqueue custom script
        wp_enqueue_script('armo-makeup-modal', WP_ARMO_MAKEUP_URL . 'assets/js/modal.js', array('micromodal'), WP_ARMO_MAKEUP_VERSION, true);
    
        // Add custom styles
        wp_enqueue_style('armo-makeup-modal', WP_ARMO_MAKEUP_URL . 'assets/css/modal.css', array(), WP_ARMO_MAKEUP_VERSION);
    
        // Localize script
        wp_localize_script('armo-makeup-modal', 'armoMakeup', array(
            'ajaxUrl' => admin_url('admin-ajax.php'),
            'productId' => $product_id,
            'nonce' => wp_create_nonce('armo_makeup_nonce')
        ));
    }

    public function add_virtual_makeup_button_float() {
        if (!is_product()) {
            return;
        }

        $product_id = get_the_ID();
        $is_enabled = get_post_meta($product_id, 'is_enable_virtual_makeup', true);

        if ($is_enabled != 'yes') {
            return;
        }



        ?>
        <div class="virtual-makeup-button-container">
            <span class="toast">آرایش مجازی</span>
            <button class="virtual-makeup-button" data-micromodal-trigger="modal-virtual-makeup">
                <svg xmlns="http://www.w3.org/2000/svg" id="Mirror" viewBox="0 0 64 64"><path d="M29.99072266,62.99853516c-.3515625,0-.70751953-.03662109-1.05859375-.10888672-1.90380859-.39404297-3.44287109-1.94824219-3.82861328-3.8671875-.25244141-1.25244141-.03027344-2.52978516.62548828-3.59570312.83251953-1.35546875.93017578-2.87646484.86572266-3.9140625-.16845703-2.68798828-1.87646484-4.99902344-4.45751953-6.03173828-8.45605469-3.38378906-14.13720703-12.01611328-14.13720703-21.48095703C8,11.31787109,17.86914062,1,30,1s22,10.31787109,22,23c0,9.46484375-5.68115234,18.09716797-14.13720703,21.48095703-2.58105469,1.03271484-4.2890625,3.34375-4.45751953,6.03125-.09326172,1.49267578.20410156,2.84277344.859375,3.90429688.48144531.77832031.73535156,1.67138672.73535156,2.58349609,0,1.50976562-.67236328,2.92382812-1.84423828,3.87841797-.88671875.72216797-2.01074219,1.12011719-3.16503906,1.12011719Z" style="fill:#ff6c9d; stroke-width:0px;"/><path d="M30,42c-9.37402344,0-17-8.07470703-17-18S20.62597656,6,30,6s17,8.07470703,17,18-7.62597656,18-17,18Z" style="fill:#d9ecff; stroke-width:0px;"/><path d="M7.83837891,55.02978516c-.50146484-3.00878906-2.84765625-5.43164062-5.83837891-6.02978516,2.99072266-.59814453,5.33691406-3.02099609,5.83837891-6.02978516l.16162109-.97021484.16162109.97021484c.50146484,3.00878906,2.84765625,5.43164062,5.83837891,6.02978516-2.99072266.59814453-5.33691406,3.02099609-5.83837891,6.02978516l-.16162109.96923828-.16162109-.96923828Z" style="fill:#ffe094; stroke-width:0px;"/><path d="M56.80859375,12.04296875c-.49121094-2.45605469-2.37890625-4.43554688-4.80859375-5.04296875,2.4296875-.60742188,4.31738281-2.58691406,4.80859375-5.04296875l.19140625-.95703125.19140625.95703125c.49121094,2.45605469,2.37890625,4.43554688,4.80859375,5.04296875-2.4296875.60742188-4.31738281,2.58691406-4.80859375,5.04296875l-.19140625.95605469-.19140625-.95605469Z" style="fill:#ffe094; stroke-width:0px;"/><path d="M30,0C17.31787109,0,7,10.76611328,7,24c0,9.87011719,5.93408203,18.87548828,14.765625,22.40917969,2.21923828.88818359,3.68701172,2.8671875,3.83105469,5.16552734.05566406.89355469-.02392578,2.19580078-.71972656,3.328125-.78857422,1.28271484-1.05615234,2.81591797-.75390625,4.31689453.46386719,2.30664062,2.31494141,4.17480469,4.60742188,4.64941406.41992188.08642578.84179688.12939453,1.26025391.12939453,1.37988281,0,2.71679688-.46533203,3.79638672-1.34472656,1.40625-1.14550781,2.21289062-2.84179688,2.21289062-4.65380859,0-1.09814453-.30566406-2.17285156-.88427734-3.10888672-.68994141-1.1171875-.76953125-2.40283203-.71240234-3.31640625.14404297-2.29833984,1.61181641-4.27734375,3.83105469-5.16552734,8.83154297-3.53369141,14.765625-12.5390625,14.765625-22.40917969C53,10.76611328,42.68212891,0,30,0ZM37.49121094,44.55273438c-2.94335938,1.17773438-4.89111328,3.8203125-5.0859375,6.92919922-.10498047,1.6796875.24414062,3.22216797,1.00927734,4.46044922.3828125.61962891.58544922,1.33105469.58544922,2.05761719,0,1.20800781-.53808594,2.33935547-1.47607422,3.10351562-.95117188.77490234-2.15478516,1.0625-3.38867188.80664062-1.51708984-.31347656-2.74365234-1.55322266-3.05126953-3.08496094-.20507812-1.01855469-.03320312-2.01269531.49707031-2.875.76757812-1.24902344,1.11767578-2.80517578,1.01171875-4.50048828-.19287109-3.07666016-2.140625-5.71923828-5.08398438-6.89697266-8.08007812-3.23291016-13.50878906-11.49267578-13.50878906-20.55273438C9,11.86914062,18.42041016,2,30,2s21,9.86914062,21,22c0,9.06005859-5.42871094,17.31982422-13.50878906,20.55273438Z" style="fill:#393e4c; stroke-width:0px;"/><path d="M30,5c-9.92529297,0-18,8.5234375-18,19s8.07470703,19,18,19c9.50128174,0,17.2868042-7.81622314,17.93640137-17.67407227.06097412-.17541504.06427002-.35687256.02563477-.53503418.01037598-.26428223.03796387-.52392578.03796387-.79089355,0-10.4765625-8.07470703-19-18-19ZM45.04418945,29.73132324L21.27734375,9.76715088c1.04370117-.72460938,2.17382812-1.31414795,3.36651611-1.76641846l21.28851318,17.41784668c-.11767578,1.50280762-.42523193,2.94549561-.88818359,4.31274414ZM45.94488525,22.84466553L26.96520996,7.3157959c.98370361-.20166016,1.996521-.3157959,3.03479004-.3157959,8.45526123,0,15.38171387,7.00970459,15.94488525,15.84466553ZM30,41c-8.82226562,0-16-7.62597656-16-17,0-3.34954834.92895508-6.46685791,2.50939941-9.10186768l14.83581543,12.85772705c.18896484.16357422.42236328.24414062.65429688.24414062.27978516,0,.55859375-.11669922.75634766-.34521484.36132812-.41699219.31640625-1.04882812-.10107422-1.41064453l-15-13c-.00708008-.00610352-.01629639-.00732422-.02349854-.01324463.61645508-.79785156,1.30383301-1.52990723,2.04492188-2.19708252l24.57891846,20.64630127c-2.64599609,5.52124023-8.03521729,9.31988525-14.25512695,9.31988525Z" style="fill:#393e4c; stroke-width:0px;"/><circle cx="30" cy="58" r="1" style="fill:#393e4c; stroke-width:0px;"/><path d="M14.19628906,48.01953125c-2.5859375-.51708984-4.61474609-2.61279297-5.04833984-5.21386719l-.16162109-.97021484c-.08007812-.48193359-.49755859-.83544922-.98632812-.83544922s-.90625.35351562-.98632812.83544922l-.16162109.97021484c-.43359375,2.60107422-2.46240234,4.69677734-5.04833984,5.21386719-.46728516.09326172-.80371094.50390625-.80371094.98046875s.33642578.88720703.80371094.98046875c2.5859375.51708984,4.61474609,2.61279297,5.04833984,5.21386719l.16162109.97021484c.08007812.48193359.49755859.83544922.98632812.83544922s.90625-.35351562.98632812-.83544922l.16162109-.97021484c.43359375-2.60107422,2.46240234-4.69677734,5.04833984-5.21386719.46728516-.09326172.80371094-.50390625.80371094-.98046875s-.33642578-.88720703-.80371094-.98046875ZM8,52.39941406c-.734375-1.41259766-1.85986328-2.59521484-3.23193359-3.39941406,1.37207031-.80419922,2.49755859-1.98681641,3.23193359-3.39941406.734375,1.41259766,1.85986328,2.59521484,3.23193359,3.39941406-1.37207031.80419922-2.49755859,1.98681641-3.23193359,3.39941406Z" style="fill:#393e4c; stroke-width:0px;"/><path d="M62.24267578,6.02978516c-2.05712891-.51416016-3.65478516-2.18994141-4.07080078-4.26904297l-.19140625-.95703125c-.09326172-.46728516-.50390625-.80371094-.98046875-.80371094s-.88720703.33642578-.98046875.80371094l-.19140625.95703125c-.41601562,2.07910156-2.01367188,3.75488281-4.07080078,4.26904297-.4448287.11132812-.75732422.51123047-.75732422.97021484s.31249552.85888672.75732422.97021484c2.05712891.51416016,3.65478516,2.18994141,4.07080078,4.26904297l.19140625.95703125c.09326172.46728516.50390625.80371094.98046875.80371094s.88720703-.33642578.98046875-.80371094l.19140625-.95703125c.41601562-2.07910156,2.01367188-3.75488281,4.07080078-4.26904297.44481945-.11132812.75732422-.51123047.75732422-.97021484s-.31250477-.85888672-.75732422-.97021484ZM57,9.69726562c-.60449219-1.09179688-1.47363281-2.02099609-2.52197266-2.69726562,1.04833984-.67626953,1.91748047-1.60546875,2.52197266-2.69726562.60449219,1.09179688,1.47363281,2.02099609,2.52197266,2.69726562-1.04833984.67626953-1.91748047,1.60546875-2.52197266,2.69726562Z" style="fill:#393e4c; stroke-width:0px;"/></svg>
            </button>
        </div>

        <?php
    }


    public function add_virtual_makeup_button_fixed() {
        if (!is_product()) {
            return;
        }

        $product_id = get_the_ID();
        $is_enabled = get_post_meta($product_id, 'is_enable_virtual_makeup', true);

        if ($is_enabled != 'yes') {
            return;
        }
        ?>

        <button class="virtual-makeup-button desktop-preview" data-micromodal-trigger="modal-virtual-makeup">
            <svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-wand"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M6 21l15 -15l-3 -3l-15 15l3 3" /><path d="M15 6l3 3" /><path d="M9 3a2 2 0 0 0 2 2a2 2 0 0 0 -2 2a2 2 0 0 0 -2 -2a2 2 0 0 0 2 -2" /><path d="M19 13a2 2 0 0 0 2 2a2 2 0 0 0 -2 2a2 2 0 0 0 -2 -2a2 2 0 0 0 2 -2" /></svg>
            <span>تست مجازی محصول</span>
        </button>
        <?php
    }

    public function add_modal_markup() {
        if (!is_product()) {
            return;
        }

        $product_id = get_the_ID();
        $is_enabled = get_post_meta($product_id, 'is_enable_virtual_makeup', true);

        if ($is_enabled != 'yes') {
            return;
        }

        ?>

        <div class="modal micromodal-slide" id="modal-virtual-makeup" aria-hidden="true">
            <div class="modal__overlay" tabindex="-1" data-micromodal-close>
                <div class="modal__container" role="dialog" aria-modal="true" aria-labelledby="modal-1-title">
                    <header class="modal__header">
                        <button class="modal__close" aria-label="Close modal" data-micromodal-close></button>
                    </header>
                    <main class="modal__content" id="modal-virtual-makeup-content" >
                        در حال بارگزاری...
                    </main>
                </div>
            </div>
        </div>
        <?php

    }


    public function load_makeup_iframe() {
        check_ajax_referer('armo_makeup_nonce', 'nonce');
        
        $product_id = isset($_POST['product_id']) ? intval($_POST['product_id']) : 0;
        
        if (!$product_id) {
            wp_send_json_error('Invalid product ID');
        }
        
        $makeup_url = home_url('makeup/' . $product_id);
        wp_send_json_success(array(
            'iframe' => '<iframe src="' . esc_url($makeup_url) . '" frameborder="0" width="100%" height="500px"></iframe>'
        ));
    }
}